= 选择正确的群集拓扑

:keywords: deploy, esb, amc, cloudhub, on premises, on premise, clusters

您可以在许多不同的拓扑中部署Mule ESB。在构建Mule应用程序时，重要的是要认真思考如何最佳地构建应用程序以实现所需的可用性，容错性和性能特征。本页概述了通过群集实现这些特征的正确组合的一些解决方案。对每个人来说没有一个正确的方法，设计你的系统既是一门艺术，也是一门科学。如果您需要更多帮助，MuleSoft专业服务可以通过查看您的架构计划或为您设计帮助您。有关更多信息，请参阅 link:http://www.mulesoft.com/contact[联系我们]。

== 关于集群

将应用程序部署到集群对实现以下目标非常有用：

* 高可用性（HA）：在群集中的一台或多台服务器或数据中心发生故障时，使您的系统持续可用。

* 容错（FT）：确保从基础组件的故障中恢复。通常，通过事务回滚或补偿操作来实现恢复。

* 缩放：确保您的应用程序可以水平缩放以满足增加的需求。

本页介绍了几种可能的群集解决方案。

==  Mule高可用性

*_Enterprise Edition_*

[cols="2*"]
|===
一个|
Mule高可用性为Mule提供基本的故障切换功能。当主Mule实例变得不可用时（例如，由于致命的JVM或硬件故障或因脱机进行维护），备份Mule实例会立即成为主节点，并恢复处理失败实例中断的情况。系统管理员恢复失败的Mule实例并使其恢复联机后，它将自动成为备份节点。

无缝故障转移由分布式内存存储实现，该存储共享群集Mule实例之间的所有瞬态信息，例如：

*  SEDA服务事件队列
* 内存中的消息队列

Mule高可用性目前可用于以下传输：

*  HTTP（包括CXF Web服务）
*  JMS
*  WebSphere MQ
*  JDBC
* 文件
*  FTP
* 群集（取代本地VM传输）

| image:HA-arch.png[HA-拱]

|===

Mule高可用性适用于Mule Enterprise订阅。有关详细信息，包括技术亮点，要求和安装详细信息，请mailto：sales@mulesoft.com [联系我们]。

==  JMS队列

JMS可用于通过JMS队列路由消息来实现HA＆FT。在这种情况下，每当从一个组件向一个组件移动时，每条消息都通过一个JMS队列进行路由。

image:jms-queues.png[JMS队列]

优点：

* 容易做到

* 开发人员很好理解

缺点：

* 需要大量交易，并且交易可能很复杂

如果您使用XA，则* 性能会受到影响

== 负载平衡器

负载均衡器根据每个服务器的当前负载和当前正在运行的服务器，简单地将请求路由到不同的服务器。负载平衡器可以基于软件或硬件。这种方法通常用于集群数据库（见下文）。

优点：

* 直接做

* 开发人员很好理解

缺点：

* 不是完整的解决方案，不提供容错功能。

== 示例

在这个示例体系结构中，HTTP请求通过负载均衡器进入，并立即放入JMS队列中。 JMS队列在不同的服务器之间聚集。服务器将开始处理JMS队列中的消息，并将所有内容都包含在事务中。

image:http_and_jms.png[http_and_jms]

如果服务器停机，事务将回滚，另一台服务器将收到消息并开始处理它。

*Note*：如果HTTP连接在此过程中处于打开状态，则此方法无效，因为负载平衡器不会透明地切换服务器之间的连接。在这种情况下，HTTP客户端需要重试请求。

== 维护数据库中的状态

如果你有一个集群数据库，你的应用程序的一个选择就是简单地将所有状态存储在数据库中，并依靠它来在整个服务器上一致地复制数据。

优点：

* 直接做

* 开发人员很好理解

缺点：

* 并非所有状态都可以存储在数据库中

== 处理有状态组件

虽然大多数应用程序可以通过上述技术来支持，但有些需要更深入地在JVM之间共享状态。

一个常见的例子是聚合器组件。例如，假设您有一个汇总来自两个不同生产者的消息。生产者＃1向聚合器发送消息，该聚合器接收该消息并将其保存在内存中，直到生产者＃2发送消息。

[source, code, linenums]
----
Producer #1 --->  |----------|
                  |Aggregator| --> Some other component
Producer #2 --->  |----------|
----

如果带聚合器的服务器在发送消息的生产者＃1和发送消息的生产者＃2之间发生故障，则生产者＃2不能只将消息发送到不同的服务器，因为该服务器不会从生产者＃1发送消息。

解决方案是通过集群软件（如Terracotta，Tangosol Coherence，JGroups等）在不同的机器上共享聚合器组件的状态。通过使用其中一种工具，Producer＃2可以简单地故障转移到不同的服务器。请注意，MuleSoft没有使用这些工具测试Mule，并且不正式支持它们。

优点：

* 适用于所有集群案例

* 也可以作为缓存工作

缺点：

*  MuleSoft没有正式支持

* 需要进行性能调整才能有效地工作

== 相关主题

在设计拓扑结构时，需要记住的其他几个主题超出了本文档的范围：

* 维护地理分布的群集

* 数据分区

*  ACID与BASE交易

* 薪酬和交易
