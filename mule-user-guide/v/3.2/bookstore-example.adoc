= 书店示例

书店示例演示如何：

* 将Mule ESB作为servlet容器内的Web应用程序运行（使用Jetty连接器）
* 使用Mule与Servlet传输
* 将Mule与CXF Web服务结合使用

您可以在Mule用户指南中阅读有关Jetty连接器，Servlet传输和CXF模块的更多信息。

== 书店示例概述

书店的例子包括以下内容：

* 书店目录服务，带有用于浏览目录的公共界面和用于向目录添加书籍的管理界面
* 允许客户订购图书的订单服务
* 电子邮件通知服务，当订单已发出时发送电子邮件。
* 数据仓库服务，用于跟踪图书统计信息，例如已售图书数量，总收入和畅销书。

该示例捆绑了两个Web应用程序：

*  Admin webapp包含Mule配置文件和服务定义。该模块位于防火墙后面。
*  Bookstore webapp包含用于向防火墙外部的客户显示目录的JSP。

为了使示例轻松部署，两个Web应用程序都捆绑在一起，放在单独的Mule应用程序中。在现实世界中，两个Web应用程序将使用以下架构分开部署：

image:bookstore-example-arch.png[书店 - 例如，arch.png]

== 运行示例

Bookstore示例被配置为在Mule服务器上的嵌入式jetty servlet容器中运行。

要运行Bookstore示例，只需将`mule-example-bookstore-3.1.0.zip`应用程序存档从示例目录复制到`<MULE_HOME>/apps`目录，然后启动Mule。

要重建该示例，您必须使用Maven或使用书店示例作为模板在Mule IDE中创建一个新项目。

这些应用程序将在以下URL中可用：

* 主书店应用（搜索和订购书籍）：http：// localhost：8083 / bookstore
* 管理员应用程序（添加书籍和获取订单统计信息）：http：// localhost：8083 / bookstore-admin

== 服务详情

这些服务在`examples\bookstore\src\main\resources`目录的`bookstore-config.xml`文件中定义。该文件包含四个流程：

[source,xml]
----
<?xml version="1.0" encoding="UTF-8"?><mule xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"    xmlns:context="http://www.springframework.org/schema/context"    xmlns:vm="http://www.mulesoft.org/schema/mule/vm" xmlns:cxf="http://www.mulesoft.org/schema/mule/cxf"    xmlns:smtp="http://www.mulesoft.org/schema/mule/smtp" xmlns:smtps="http://www.mulesoft.org/schema/mule/smtps"    xmlns:email="http://www.mulesoft.org/schema/mule/email"    xmlns:servlet="http://www.mulesoft.org/schema/mule/servlet"    xsi:schemaLocation="        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd        http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/3.1/mule.xsd        http://www.mulesoft.org/schema/mule/vm http://www.mulesoft.org/schema/mule/vm/3.1/mule-vm.xsd        http://www.mulesoft.org/schema/mule/cxf http://www.mulesoft.org/schema/mule/cxf/3.1/mule-cxf.xsd        http://www.mulesoft.org/schema/mule/smtp http://www.mulesoft.org/schema/mule/smtp/3.1/mule-smtp.xsd        http://www.mulesoft.org/schema/mule/smtps http://www.mulesoft.org/schema/mule/smtps/3.1/mule-smtps.xsd        http://www.mulesoft.org/schema/mule/email http://www.mulesoft.org/schema/mule/email/3.1/mule-email.xsd        http://www.mulesoft.org/schema/mule/servlet http://www.mulesoft.org/schema/mule/servlet/3.1/mule-servlet.xsd">    <context:property-placeholder location="email.properties" />    <!-- Configure some properties to work with GMail's SMTP -->    <smtp:gmail-connector name="emailConnector" />    <!-- Use this as a poor man's message queue, in the real world we would use JMS -->    <vm:connector name="vmQueues" />    <!-- This queue contains a feed of the latest statistics generated by         the Data Warehouse (it should really be a LIFO queue) -->    <vm:endpoint name="stats" path="statistics" exchange-pattern="one-way" />    <message-properties-transformer name="setHtmlContentType" overwrite="true">        <add-message-property key="Content-Type" value="text/html" />        <!-- Tomcat lowercases headers, need to drop this old one too -->        <delete-message-property key="content-type" />    </message-properties-transformer>    <flow name="CatalogService">        <composite-source>            <!-- Public interface -->            <inbound-endpoint address="http://0.0.0.0:8777/services/catalog" exchange-pattern="request-response">                <cxf:jaxws-service serviceClass="org.mule.example.bookstore.CatalogService" />            </inbound-endpoint>            <!-- Administration interface -->            <inbound-endpoint address="servlet://catalog" exchange-pattern="request-response">                <!-- Convert request parameters to Book object -->                <custom-transformer class="org.mule.example.bookstore.transformers.HttpRequestToBook" />                <response>                    <!-- Format response to be a nice HTML page -->                    <custom-transformer class="org.mule.example.bookstore.transformers.AddBookResponse" />                    <!-- Force text/html, otherwise it falls back to request                         props, which have form-encoded one -->                    <transformer ref="setHtmlContentType" />                </response>            </inbound-endpoint>        </composite-source>        <component>            <singleton-object class="org.mule.example.bookstore.CatalogServiceImpl" />        </component>    </flow>    <flow name="OrderService">        <!-- Public interface -->        <inbound-endpoint address="http://0.0.0.0:8777/services/order" exchange-pattern="request-response">            <cxf:jaxws-service serviceClass="org.mule.example.bookstore.OrderService" />        </inbound-endpoint>        <component>            <singleton-object class="org.mule.example.bookstore.OrderServiceImpl" />        </component>        <vm:outbound-endpoint path="emailNotification" exchange-pattern="one-way" />        <vm:outbound-endpoint path="dataWarehouse" exchange-pattern="one-way" />    </flow>    <flow name="EmailNotificationService">        <vm:inbound-endpoint path="emailNotification" exchange-pattern="one-way" />        <smtps:outbound-endpoint user="${user}" password="${password}" host="${host}" from="${from}" subject="Your order has been placed!">            <custom-transformer class="org.mule.example.bookstore.transformers.OrderToEmailTransformer" />            <email:string-to-email-transformer />        </smtps:outbound-endpoint>    </flow>    <flow name="DataWarehouse">        <vm:inbound-endpoint path="dataWarehouse" exchange-pattern="one-way" />        <component>            <singleton-object class="org.mule.example.bookstore.DataWarehouse" />        </component>        <outbound-endpoint ref="stats">            <transformer ref="setHtmlContentType" />        </outbound-endpoint>    </flow></mule>
----

== 管理Web应用程序

当管理员在管理员应用程序中添加书籍时，网页中的信息将通过Servlet传输上的POST方法`<form method="POST" action="../catalog">`以HTTP请求的形式发送到`servlet://catalog`。然后Mule将HTTP请求转换为`Book`对象，该对象通过`addBook`方法传递到Catalog服务。

位于Mule目录下的`examples\bookstore\src\main\app\bookstore-admin\WEB-INF`目录中的Admin webapp `web.xml`文件提供Mule配置作为上下文参数，以便Mule可以在webapp中启动：

[source,xml]
----
<web-app>    <display-name>Bookstore Administration</display-name>    <description>Administration console for the Mule-powered On-line Bookstore</description>    <!-- The Mule configuration is provided as a context parameter -->    <context-param>        <param-name>org.mule.config</param-name>        <param-value>bookstore-config.xml</param-value>    </context-param>    <!-- This listener will start up Mule inside the webapp -->    <listener>        <listener-class>org.mule.config.builders.MuleXmlBuilderContextListener</listener-class>    </listener>...
----

用于构建网页`admin.jsp`的JSP位于`examples\bookstore\src\main\app\bookstore-admin`目录中。

== 书店Webapp

当客户通过书店Web应用程序搜索目录时，在目录服务上调用`getBooks()`方法。该请求通过CXF传输`cxf:http://localhost:8777/services/catalog`发送，它在Java和WSDL / XML之间编组请求。目录服务使用`Book`对象进行回复，该对象作为CXF编组的XML响应发回，结果显示在HTML页面中。

位于Mule目录下的`examples\bookstore\src\main\app\bookstore\WEB-INF`目录中的Bookstore webapp `web.xml`文件加载目录JSP，以便在客户的HTML页面中显示：

[source,xml]
----
<web-app>    <display-name>On-line Bookstore</display-name>    <description>Mule-powered On-line Bookstore</description>    <welcome-file-list>        <welcome-file>catalog.jsp</welcome-file>    </welcome-file-list></web-app>
----

HTML页面如下所示：
+
image:bookstore-example-html.png[图片]

==  Java类

Admin webapp的Java类位于`examples\bookstore\src\main\java\org\mule\example\bookstore`中。 `CatalogServiceImpl.java`类定义了添加和获取书籍的方法。 `OrderServiceImpl.java`类定义了`orderBook()`方法。 `DataWarehouse.java`类定义了更新页面统计信息的方法，检索最畅销的商品，并在页面上打印统计信息。

诸如`Book`和`Order`之类的域对象在`examples\bookstore\src\main\java\org\mule\example\bookstore`中的Java类中定义。

除了定义各种方法之外，Java文件还包含注释。 `@WebService`让CXF知道这是一个JAX-WS服务。例如，`CatalogServiceImpl.java`包含以下注释：

[source,xml]
----
@WebService(serviceName="CatalogService", endpointInterface="org.mule.example.bookstore.CatalogService")
----

`serviceName`属性指定WSDL中的服务名称为"CatalogService"。 `endpointInterface`属性将控制CXF用来构建WSDL的接口。如果没有指定，CXF将使用您的Web服务实现类来生成WSDL，因此期望在那里找到任何`@WebParam`和`@WebResult`注释。

`@WebResult`和`@WebParam`注释用于定义WSDL中的参数名称（Java不在类文件中存储参数名称，因此必须提供注释）：

[source,xml]
----
@WebResult(name="order")   Order orderBook(@WebParam(name="book") Book book,     @WebParam(name="quantity") int quantity,     @WebParam(name="address") String address,    @WebParam(name="email") String email);
----


== 变压器

`examples\bookstore\src\main\java\org\mule\example\bookstore\transformers`目录包含执行以下操作的变换器：

* 将书籍添加到响应消息中，并使用`examples\bookstore\src\main\java\org\mule\example\bookstore\web`中的HTML模板将其封装在HTML正文中。
* 根据图书订单撰写电子邮件通知消息。然后使用电子邮件传输中的`<string-to-email-transformer>`将文本转换为电子邮件。
* 将HttpRequest参数映射转换为Book对象。
