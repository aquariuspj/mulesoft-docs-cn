= 高可用性和灾难恢复
:keywords: high availability, high, disaster, recovery
：imagesdir：./_images

计划内或计划外的基础设施和应用程序停机时间可能随时出现，无论从哪个方向，以任何形式出现。在技​​术中断，设施破坏，人员流失或关键第三方服务丢失期间保持组织运作的能力对于防止对企业造成不可逆转的损害至关重要。随着全球向电子商务模式的转变以及对全天候应用正常运行时间的依赖，高可用性（HA）和灾难恢复（DR）影响了组织的财务状况。

下表显示了即使最少的停机时间加起来对组织产生负面影响：

[%header,cols="25a,25a,25a,25a"]
|===
|正常运行时间百分比 |百分比停机时间 |每周停机时间 |每年停机时间
| 99％ | 1％ | 1.68小时 | 3.65天
| 99.9％ | 0.1％ | 10.1分钟 | 8.75小时
| 99.99％ | 0.01％ | 1分钟 | 52.5分钟
| 99.999％ | 0.001％ | 6秒 | 5.25分钟
|===

== 高可用性与灾难恢复

*  *High availability (HA)*  - 系统在发生系统组件故障时保持可访问性的度量。通常，通过在系统中建立多级容错和/或负载平衡功能来实现HA。

*  *Disaster recovery (DR)*  - 系统在自然（洪水，龙卷风，地震，火灾等）或人为（电源故障，服务器故障）后恢复到先前可接受的状态，配置错误等）灾难。

虽然它们都提高了整体可用性，但显着的差异在于，与HA相比，通常不存在服务损失。 HA保留该服务并且DR保留数据，但是对于DR，在DR计划执行并且系统恢复时通常会有轻微的服务损失。

== 为HA和DR策略部署Mule

您可以在许多不同的拓扑中部署Mule运行时来解决您的HA和DR策略。一种方法是通过使用集群，这将在本文后面介绍。 Mule高可用性群集为Mule提供基本的故障转移功能。

例如，当主Mule Runtime变得不可用时，例如由于致命的JVM或硬件故障或其脱机进行维护，Mule Runtime的备份会立即成为主节点，并在发生故障的实例停止时恢复处理。

系统管理员恢复失败的Mule Runtime服务器并将其重新联机后，该服务器自动成为备份节点。

image:hadr-cluster.png[HADR集群]

无缝故障转移由分布式内存存储实现，该存储共享群集Mule运行时间中的所有瞬态信息，例如：

*  SEDA服务事件队列
* 内存中的消息队列

在构建Mule应用程序时，重要的是要认真思考如何最佳地构建应用程序以实现所需的可用性，容错性和性能特征。

== 创建有效的SLA

服务水平协议（SLA）概述了什么是可接受的具体定义。请参阅 link:http://www.slatemplate.com/[slatemplate.com示例SLA]，了解如何创建有助于减少停机时间的协议。

高可用性的基本定义是服务正在运行
运作，即正确处理请求和回应。这不是
意味着服务始终以满负荷运行。设计有高可用性的系统可以防止中断并防止首先发生中断。 SLA确定所有利益相关者的期望。

SLA要求：

* 消除单点故障
* 流量/请求被重定向/处理
* 检测故障

例如，基本服务可能具有以下SLA：

* 服务的正常操作每秒处理1000个事务，响应时间为1秒。
* 每年的总停机时间将为99.5％或1.83天。
* 最低可接受的服务影响级别是每秒100次事务，每周2小时响应时间为1秒。

也可以看看：

*  link:/mule-management-console/v/3.8/defining-slas-and-alerts[定义SLA和警报]
*  link:/api-manager/defining-sla-tiers[定义SLA层]
*  link:/api-manager/rate-limiting-and-throttling-sla-based-policies[速率限制和限制 - 基于SLA的策略]

== 高可用性选项

您可以通过使用节点的集群和/或负载平衡来实现高可用性。根据定义的SLA，Mule可能有四种HA选项：

*  <<Cold Standby>>
*  <<Warm Standby>>
*  <<Hot Standby - Active-Passive>>
*  <<Active-Active>>

注意：这些选项通常与灾难恢复策略相​​关联。

=== 冷备用

[%header%autowidth.spread]
|===
| {图表{1}}说明 |停机
| image:hadr-cold-standby.png[HADR冷备用]
|安装并配置Mule环境，但是一个或多个操作系统未运行。这可以是生产系统/虚拟机的备份。在检测到停电后，操作系统的环境加上Mule运行时间已开始。
|一些 - 启动环境和直接流量所需的时间。
|===

=== 热待机

[%header%autowidth.spread]
|===
| {图表{1}}说明 |停机
| image:hadr-warm-standby.png[HADR-热备份]
|安装并配置Mule环境。然而骡子运行时间不运行;只有操作系统。 Mule Runtime在检测到中断后启动。
|很少 -  Mule运行时启动并将流量路由到环境所需的时间。
|===

=== 热备 - 主动 - 被动

[%header%autowidth.spread]
|===
| {图表{1}}说明 |停机
| image:hadr-active-passive.png[HADR-主动 - 被动]
| Mule环境已安装，配置并完全运行。但是，在检测到中断之前，它不处理请求。
|最小值到无 - 将流量路由到环境的时间。
|===

=== 主动 - 主动

[%header%autowidth.spread]
|===
| {图表{1}}说明 |停机
| image:hadr-active-active1.png[HADR活性-ACTIVE1]
|负载平衡群集环境
有两个或更多的Mule环境（每个环境都有自己的集群）可以完全运行。负载平衡器正在将流量引导至所有环境。
|无 - 没有服务停机时间。
| image:hadr-active-active2.png[HADR活性-ACTIVE2]
|负载平衡的单一群集环境
有两个或更多Mule环境，但它们是同一集群环境的一部分。要实现这种情况，环境之间的网络延迟必须小于10毫秒。
|无 - 没有服务停机时间。
|===

== 高可用性部署模型

*  <<Active-Active Clustering Deployment Model>>
*  <<Active-Active Clustering Fault Tolerance Deployment Model>>
*  <<Zero Downtime Deployment Model>>

=== 主动 - 主动集群部署模型

合理的和/或负载平衡的两个节点可以支持1,500 TPS并且有一秒响应。在这种状态下，SLA的正常运行正在得到满足。如果节点失败，则服务受到影响。但是，该影响不会违反SLA，因为该节点能够在一秒内处理700 TPS;远高于商定的可接受的影响水平。

image:hadr-aa-clustering.png[HADR-AA-集群]

在多个Mule节点间均匀分配负载：

* 所有节点都提供相同的功能
* 所有节点同时处于活动状态。

*Costs*

根据SLA要求而有所不同。该模型需要2个节点来满足SLA。如果SLA的可接受服务影响更改为正常操作中所述的条款，则环境至少需要3个节点才能容纳1个节点故障。取决于没有至少2个节点运行的可能性，可能需要更多的节点。

=== 主动 - 主动群集容错部署模型

容错的基本定义是系统内的故障根本不影响服务。这与高可用性不同，因为可以承受服务影响和停机时间。

image:hadr-fault-tolerant.png[HADR容错]

通过提供额外的资源，允许应用程序在组件故障后继续运行而不会中断，故障容错与高可用性不同。容错环境比高可用环境成本更高。

容错程度要求系统失败的概率。以高可用性突出显示SLA示例，并使最低可接受的服务影响级别与正常操作要求匹配。

新的整体SLA现在要求系统能够每秒处理1000个事务，响应时间为1秒，停机时间为零，服务影响为零。

如果超过1个节点失败的概率很低，那么架构只需要3个节点。但是，如果超过1个节点的概率高于可接受的范围，则需要超过3个节点来适应多个故障。

*Costs*

由于需要冗余才能达到定义的SLA，因此成本更高。

{0}}零停机时间部署模型

目标是能够在不影响SLA的情况下快速更改环境;包括升级基础设施和基础设施上运行的应用程序。典型情况下，零停机时间部署利用并行部署，即在短时间内新老共存。这与就地部署相比，服务可能会减少完成停机时间的能力。

http://www.gartner.com/it-glossary/continuous-operations/[Gartner公司]将连续操作定义为“数据处理系统的那些特性，以减少或消除计划内停机时间的需求，如定期维护。一天24小时，每周七天的运作“。

请参阅 link:https://www.virtualizationpractice.com/continuous-operations-for-zero-downtime-deployments-22680/[本文]以获取完整说明和常见解决方案。

基准生产环境是当前的操作环境。通过更改（升级的运行时，配置，新应用程序等）创建新环境。一小部分流量流入新环境，并随着新环境的信心增加而增加。基准生产环境继续使用，直到新环境全面运行（它正在处理100％的流量）。一旦新环境接受所有流量，它就成为新的基准生产环境，并且以前的基准生产环境终止。

下面的例子假定每个环境使用相同数量的Mule运行时和内核。新环境的数量可能比基准环境的数量更多或更少，这似乎是合理的。

[%header,cols="60a,40a"]
|===
|部署步骤 |图
|部署新生产环境并将少部分流量路由到新环境。
| image:hadr-zero-downtime-1.png[HADR-零停机-1]

|新环境中的信心持续增加，更多的流量被路由到它。
| image:hadr-zero-downtime-2.png[HADR-零停机-2-]

|所有流量都已路由到新环境。
| image:hadr-zero-downtime-3.png[HADR-零停机-3-]

|所有流量都已路由到已升级到基准生产环境的新环境;之前的基准环境已经终止。
| image:hadr-zero-downtime-4.png[HADR-零停机-4-]
|===

*Costs*

此部署方法可能会临时向服务添加容量（可能为几分钟，几小时或几天）。

== 灾难恢复

*How quickly can your company get back to work after an IT emergency?*

灾难恢复（DR）是系统在自然或人为灾难之后恢复到先前可接受的状态的过程。根据业务需求来选择适当的灾难恢复战略非常重要。对于灾难恢复，使用恢复时间目标（RTO）和恢复点目标（RPO）等可衡量的特性来推动灾难恢复计划。

灾难恢复与您的恢复点目标（RPO）和恢复时间目标（RTO）有关。 RPO是您在IT灾难发生后返回的"point"。例如，如果您每24小时进行一次备份，则RPO最多为24小时前。另一方面，RTO可以让您快速恢复到您的RP​​O并恢复业务。这包括一些活动，例如，如果主设备无法正常工作，请让备用设备开始运行备份。

系统备份是坚实的灾难恢复计划的主要组成部分。有三种恢复类型：冷，热和热。

[%header%autowidth.spread]
|===
|效期 |定义 |示例
|恢复时间目标（RTO）
|您需要多快才能恢复此资产？
| 1分钟？ 15分钟？ 1小时？ 4小时？ 1天？

|恢复点目标（RPO）
|资产的复苏要多么新鲜？
|零数据丢失，过时15分钟？
|===

*Topics*

*  <<Disaster Recovery with Mule>>
*  <<Anypoint CloudHub Default Deployment Model>>
*  <<Anypoint CloudHub Alternative Deployment Model>>

使用Mule进行灾难恢复。=== 

Anypoint Cloudhub通过在区域内重新部署应用程序，为应用程序和硬件故障提供灾难恢复。如果应用程序使用多个工作人员，CloudHub将其部署在同一区域内的不同可用区域中，从而跨可用区域提供HA。可用性区域之间的距离是可变的，通常不能认为它们相距350英里或更远。如果应用程序使用单个工作人员，则当可用区域关闭时，CloudHub会将其作为监视SYNC进程的一部分进行检测，但最多可能需要30分钟。 CloudHub会将该可用区域列入黑名单，并为其提供一名健康的新员工。 Mulesoft强烈建议使用CloudHub Fabric，并将多名工作人员用于关键应用程序。

image:hadr-aws-global-infrastructure.png[HADR-AWS-全球基础设施]

CloudHub将Amazon AWS用于其云基础架构。因此CloudHub的可用性取决于亚马逊。 CloudHub中的可用性和部署分为不同的地区，而这些地区又指向亚马逊地区。如果亚马逊地区发生故障，该地区内的应用程序将不可用，并且不会在其他地区（自动）复制。

如果美国东部地区出现故障，那么CloudHub管理界面以及各种支持部署的休息服务将一直持续下去，直到该地区恢复。这一点很重要，因为这可能意味着在美国东部倒闭时无法部署新应用。

CloudHub以永久队列（利用Amazon SQS）的形式提供内部消息传递机制，可用于消息可靠性。持久队列在区域内高度可用。但是，当该区域出现故障时可能会丢失数据，这可能会导致一些数据丢失（通常取决于用例，数秒或数分钟）。

某些CloudHub模块 -  Object Store V1，应用程序设置和Insight相关信息在美国东部为所有应用程序维护，而不管其部署在哪个区域。 link:/object-store/[对象存储V2]与部署的CloudHub应用程序在同一区域内维护。对于Object Store V1和V2（如果某个区域出现故障），数据会保持不变，并在该区域返回服务后可用。

VPC设置位于区域级别。因此，如果某个区域出现故障，除非先前为其他区域执行了VPC设置，否则VPC不可用。

===  Anypoint CloudHub默认部署模型

如果应用程序使用多个工作人员，则默认情况下，CloudHub会将这些工作人员部署在单独的可用区中，并在可用区内提供HA。可用性区域之间的距离是可变的，一般不超过350英里以外。

image:hadr-am-web-services.png[HADR-AM-Web的服务]

如果应用程序使用单个工作人员，则当可用区域关闭时，需要手动启动。可以在`status.mulesoft.com`中设置警报，以便在可用区域或区域级别发生故障时接收警报。

===  Anypoint CloudHub替代部署模型

可以将负载均衡器（云/本地）指向部署到不同地区的应用程序，以提供更好的灾难恢复策略。

image:hadr-load-balancer.png[HADR的负载均衡]

== 保持集成无状态

作为一个通用的设计原则，确保整合在本质上是无状态的，这一直很重要。这意味着在各种客户调用或执行之间不会有事务信息共享（在预定服务的情况下）。如果由于系统限制必须由中间件维护某些数据，则应将其保存在外部存储库（如数据库或消息传递队列）中，而不是保存在中间件基础结构或内存中。需要注意的是，随着我们扩展，特别是在云中，每个工作人员/节点使用的状态和资源应该独立于其他工作人员。该模型确保了更好的性能，可扩展性和可靠性。
