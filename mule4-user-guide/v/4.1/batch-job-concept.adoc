= 关于批量作业

Mule批处理的核心在于批处理作业范围内。批处理作业是将大消息分解为记录的作用域。这样，运行时可以异步处理这些大消息。 +
就像流程处理消息一样，批处理作业处理记录。

批处理作业包含一个或多个批处理步骤，这些批处理步骤在整个批处理作业中对记录执行操作。

image::batch-processing-concept-d1bdd.png[]

批处理XML结构在Mule 4.0上进行了修改。以下示例显示突出显示批次元素的缩略细节。

[source, xml, linenums]
----
<flow name="flowOne">
	<batch:job jobName="batchJob">
		<batch:process-records>

			<batch:step name="batchStep1">
				<event processor/>
				<event processor/>
			</batch:step>

			<batch:step name="batchStep1">
				<event processor/>
				<event processor/>
			</batch:step>
		</batch:process-records>
	</batch:job>
</flow>
----

批处理作业在流程到达批处理作业的处理记录部分时执行。 +
批处理作业开始执行时，运行时将入局消息拆分为记录，将它们存储在持久队列中，然后查询并调度要处理的记录块中的记录。 +
在所有记录通过所有批处理步骤后，运行时将结束批处理作业实例并报告批处理作业结果，指示处理期间哪些记录成功，哪些失败。

默认情况下，运行时会在每个批处理块中存储100条记录。您可以自定义此大小以提高批次的性能。

每个批处理作业包含三个不同阶段：加载和分派，处理和完成。 +

=== 加载和发送

这个第一阶段是隐含的。在此阶段，运行时将执行所有幕后工作以创建批处理作业实例。实质上，这是Mule将序列化消息有效载荷转换为批处理记录集合的阶段。你不需要为这个活动发生任何配置，尽管理解Mule在这个阶段完成的任务是有用的。

.  Mule通过收集分离器发送消息有效载荷。在此阶段，运行时会创建一个新的批处理作业实例。批量作业实例是在Mule流程中执行批量作业所产生的Mule应用程序中的一个事件;它只要Mule在批处理中处理每条记录就存在。运行时使用称为批作业实例ID的唯一字符串标识每个批作业实例。 +
例如，如果您希望将本地作业实例ID传递给外部系统以引用和管理数据，改进作业的自定义日志记录，或者甚至针对该特定批作业的有意义事件发送电子邮件或SMS通知，则此标识符非常有用实例。 +
Mule通过`batchJobInstanceId`变量公开批作业实例ID。这个变量在每一步和在完成阶段都可用。
+
.  Mule创建一个持久队列并将其关联到新的批处理作业实例。
. 对于由分离器生成的每个项目，Mule创建一条记录并将其存储在队列中。这是一个"all or nothing"活动 -  Mule成功地为每个项目生成并排队记录，或者整个消息在此阶段失败。
.  Mule将批处理作业实例及其所有排队记录提交到第一批处理步骤进行处理。

=== 过程

这第二阶段是必需的。在处理阶段，运行时开始异步处理批处理中的记录。每个记录在第一个批处理步骤中移动通过事件处理器，然后在等待第二个批处理步骤处理等待直到每个记录已经通过每个批处理步骤时被发送回原始队列。只有一个队列存在，并为每个批处理步骤选择记录，进行处理，然后发回给它;每个记录都会记录它在该队列中处理的阶段。请注意，批处理作业实例不会等待其所有排队的记录在将其中的任何记录推送到下一个批处理步骤之前在一个批处理步骤中完成处理。队列是持久的。

Mule坚持所有记录的列表，因为它们成功或无法通过每个批处理步骤进行处理。如果事件处理器在批处理步骤中无法处理记录，则运行时将继续处理该批处理，并跳过每个后续批处理步骤中的失败记录。

在此阶段结束时，批处理作业实例完成，因此不再存在。

image:batch+diagram.jpeg[批次+图]

除了记录的简单处理之外，还可以在批处理步骤中对记录执行几项操作。

* 您可以通过在每个批次步骤中添加acceptExpressions来应用过滤器，以防止该步骤处理某些记录。
::例如，您可以设置一个过滤器来防止在前一步骤中处理任何处理失败的记录。

* 您可以使用批量聚合器处理器来聚合组中的记录，并将其作为批量upserts发送到外部源或服务。 +
::例如，您可以将批量聚合器配置为累积100条记录，然后将所有这些记录全部上传到Google联系人中，而不是将每个联系人（即记录）插入Google通讯录中。

=== 完成

在此阶段中，您可以选择配置运行时，以创建其针对特定批处理作业实例处理的记录的报告或摘要。此阶段的目的是让系统管理员和开发人员了解哪些记录无法解决输入数据可能存在的任何问题。

//请注意，代码段中的详细信息将被缩写以突出显示批处理阶段，作业和步骤。

// _ TODO：将完整样本更新为mule4语法
// [source，xml，linenums]
// ----
// <batch:job name="Batch3">
//         <batch:input>
//             <poll doc:name="Poll">
//                 <sfdc:authorize/>
//             </poll>
//             <set-variable/>
//         </batch:input>
//         <batch:process-records>
//             <batch:step name="Step1">
//                 <batch:record-variable-transformer/>
//                 <data-mapper:transform/>
//             </batch:step>
//             <batch:step name="Step2">
//                 <logger/>
//                 <http:request/>
//             </batch:step>
//         </batch:process-records>
//         <batch:on-complete>
//             <logger/>
//         </batch:on-complete>
// </batch:job>
// ----

Mule执行整个批处理作业后，输出成为批作业结果对象（`BatchJobResult`）。由于Mule将批处理作业处理为异步单向流，因此批处理结果不会反馈到可能触发它的流中，也不会将结果作为对调用方的响应返回。将数据馈送到批处理作业的任何事件源必须是单向的，而不是请求响应。 +
您有两种选择来处理输出：

* 在“完成”阶段创建报告，使用DataWeave使用诸如失败记录数和成功处理记录等信息，以及在哪个步骤中可能发生了任何错误。
* 引用Mule应用程序中其他位置的批处理作业结果对象以捕获和使用批处理元数据，例如特定批处理作业实例中未能处理的记录数。

如果将“完成”阶段保留为空并且不在应用程序中的其他位置引用批处理作业结果对象，则批处理作业将简单地完成，无论是失败还是成功。 +

[TIP]
--
作为一种良好做法，建议您配置一些报告失败或成功记录的机制，以便在需要时采取进一步行动。
--


== 另请参阅

*  link:batch-performance-faq[常见问题：了解批处理作业性能]
*  link:filter-records-batch-faq[常见问题解答：如何在批处理步骤中筛选记录]
