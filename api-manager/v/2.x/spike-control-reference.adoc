= 尖峰控制策略参考
：imagesdir：./_images

在Mule Runtime 4.1.0及更高版本中，Spike控制策略用于平滑API流量。该策略确保在任何给定的时间段内，不会超过最大配置请求的处理量。

尖峰控制使用滑动窗口算法。随着时间的推移，窗口会调整仅保留适合窗口时间跨度的处理后的信息。

如果当前窗口中没有请求配额，则该策略允许将请求排入队列以供日后重新处理，而无需关闭与客户端的连接。您需要配置重新处理延迟和请求数量。要完成此操作，请设置以下示例中显示的参数：

* 窗口大小：1秒。
每个窗口* 个请求：2。
* 重新处理延迟：499毫秒。
* ＃retries：1。

image:spike-control.png[接受，拒绝，排队请求时间表]

大括号描述算法接受的每个请求的生命周期，如下所示：

* 前两个请求被接受，可用配额现在为0.配额在从请求＃1经过第二个（窗口大小）后增加到1。
{＃0}}请求＃3到达，没有剩余配额，因此它排队等待499毫秒。
* 请求＃4到达，并且仍然没有剩余配额，它将排队等待499毫秒。
{＃0}}在＃3重试之前不久，请求＃1老化一秒，并且它的配额被释放，因为它落在窗外。
* 配额现在为1，并且请求＃3已成功重新处理。配额返回到0，直到请求＃2老化1秒。
{＃0}}请求＃4延迟结束并且必须被重新处理，但请求＃2和＃3尚未足够老化，并且因为不再有延迟，所以请求＃4被拒绝。
* 请求＃5到达，并且由于＃2已经超过一秒钟，请求被接受。

请求延迟是缓解流量峰值的原因。因此，在高争用情况下，后端会继续正常工作（在最后的Y毫秒内它只能服务于X个请求），查询API的用户仍然可以看到他们的请求正在服务，尽管延迟较高。当然，确切的配置完全取决于您的API和吞吐量。

您需要在API Manager中配置这些参数以应用该策略：

* 请求数量：在最近的Y毫秒中允许多少个请求。
* 时间段：以毫秒为单位的窗口大小（前一个参数中的“Y”）。
* 延迟时间（以毫秒为单位）：如果没有剩余配额，则每次请求在重试之前保留多长时间（以毫秒为单位）。
* 延迟尝试：请求在被拒绝之前重试了多少次。
* 排队限制：可以同时排队多少个请求。排队请求需要保持一个线程和一个HTTP连接。排队限制机制保护API，因为它打开阀门以确保API在发生攻击时不会停机。
* 公开标题：默认情况下已禁用，此复选框允许策略返回有关X-RateLimit标题中算法行为的信息。 MuleSoft建议客户在并且仅在API用于内部使用时启用此功能。

如前所述，此策略的唯一目的是保护API及其后端，而不是配额执行。因此，参数不取决于客户端，而取决于后端容量。使用基于SLA的速率限制策略来强制执行配额。

配置参数也严格限制为保护API和后端。 MuleSoft建议将它们设置为尽可能最低的值以确保最佳性能。

