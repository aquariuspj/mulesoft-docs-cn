= 应用费率限制1.2.0
：imagesdir：./_images

速率限制1.2.0包括速率限制1.0.0和1.1.0中的功能以及通过密钥敏感标识符应用配额的功能。此政策自Mule 4.1.0起可用

标识符是映射到字符串的DataWeave表达式，创建一个选择器键。在速率限制1.0.0和1.1.0中，当您将策略应用于API时，每个策略只有一个速率限制算法被创建，并具有配置的限制和标识。在1.2.0中，选择键是识别的一部分。因此，为每个选择器键创建一个算法，并且他们有自己的配额。

您在应用策略时指定标识符。

image:rate-limit-identifier.png[]

此示例使速率限制对每种方法都有效。每个方法的配额是独立的（每10秒3个请求）。这种策略配置可能导致以下所示的假设时间段内的事件：

image:three-req-per-10.png[]

该示例显示了以下内容：

* 每10秒允许每个HTTP方法发出3次请求（在本例中，只有GET和POST请求已经发送到API）。
* 速率限制策略以固定窗口方式工作（请参阅窗口大小括号）。
* 窗口的开始时间是独立的：引擎使用一种懒惰的创建策略，只要接收到第一个对方法的请求，就会后台处理速率限制算法。

== 使用非义务参数上的标识符应用费率限制

该标识符是非强制性参数。默认情况下，标识符为空，以保持与速率限制策略的所有先前版本的兼容性，如下所示：

* 未设置（空白）时，配额限制适用于由策略切入点匹配的每个请求（使用一个存储桶）。
* 当设置为强制性HTTP标头时，标头的每个区分大小写的值都有其自己的配额。配额是懒惰地创造的。
* 当为非强制性HTTP头，自定义头，有效载荷，查询参数或表达式设置时，每个值都有其自己的配额。
+
如果标识符未在请求中发送，则缺省为空标识符，并具有其自己的配额。此行为允许将速率限制策略应用于不受控制的客户端使用的API，同时为发送标识符的客户端提供特殊的桶（可能是内部控制的服务）。

下图说明了后一种情况，该情况对应于带有DataWeave表达式的每10秒请求3次的配额：`#[attributes.queryParam[‘customIdentifier’]]`作为策略标识符：

image:rate-limit-identifier.png[]

在这种情况下，会发生以下操作：

* 所有没有标识符的请求都被解析为空标识符，因此使用单个速率限制算法。
* 每个不同的标识符都使用一个不同的存储桶，并拥有自己的独立配额。

== 使用DataWeave表达式应用速率限制

速率限制引擎是HTTP不可知的，仅取决于DataWeave表达式的分辨率。您可以更改标识符表达式以涵盖复杂的速率限制方案。

例如，您可以使用一个标识符来配置速率限制策略，该标识符针对所有A类和C类局域网请求使用一个存储区，另一个存储区用于其他所有区域。

image:dw-apply-limiting.png[]

此配置会创建一个虚假或真实的存储桶，它与发出请求的IP地址相对应。

假和真对应于布尔值的域，而不是HTTP;然而，策略正常工作，因为引擎将解析后的表达式视为字符串。

可能的标识符必须使用DataWeave从请求中提取结果，但除此之外，您的想象力是无限的。

*Note:* HTTP RFC将标头名称声明为不区分大小写。 MuleSoft HTTP连接器将标题名称更改为小写字符。 DataWeave是关键敏感的。因此，在创建标识符表达式时，请记住以小写字母引用标题。

=== 无界标识符集

由于每个标识符都必须存在一种算法，因此仔细创建DataWeave表达式时不要返回无界的共域（或者非常大的一个），因为它需要在内存中托管相同数量的算法（如果至少有一个请求为每个可能的标识符）。例如，假设DataWeave表达式使用ip作为Internet公开的运行时的标识符。如果互联网上的每个公共IPv4 IP向该运行时发出请求，则在单个运行时中将运行3,706,452,992个算法。在每个算法平均250字节的情况下，这将在速率限制算法中大约为1TB。

MuleSoft建议使用DatatWeave表达式，该表达式可解析为有限数量的标识符，并使得到的集合尽可能小。
