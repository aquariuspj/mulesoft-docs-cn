= 调试消息处理

*  link:/mule-management-console/v/3.6/debugging-message-processing#verifying-the-overall-application-flow[验证总体应用程序流程]
*  link:/mule-management-console/v/3.7/debugging-message-processing[验证消息处理器和有效负载]

流量分析器屏幕帮助调试应用程序。您可以跟踪应用程序的消息流，这是通过不同消息处理器的消息处理路径。您还可以在特定消息处理器收到消息之前以及消息离开该消息处理器之前详细检查消息负载内容。

[WARNING]
*[Mule 3.2]*流分析不适用于群集。它主要是一个开发时间工具。但是，您可以在运行您计划部署到群集的应用程序的独立服务器上使用它。

由于安全考虑因素（例如加密敏感邮件内容），某些调试只能在测试环境中完成，而不能在生产环境中完成。

本主题面向应用程序开发人员，将向您介绍使用Mule管理控制台调试应用程序的一般步骤。它涵盖：

* 验证应用程序流
* 验证消息处理器和消息有效载荷

要查看使用控制台在应用程序逻辑中查找错误的实际示例，请参阅 link:/mule-management-console/v/3.7/debugging-the-loan-broker-example-application[调试贷款代理示例应用程序]。

== 验证总体应用程序流程

在调试应用程序时，您首先需要验证应用程序的整体流程如预期的那样。以简单贷款代理为例，您需要检查配置文件中编码的端点是否正确并按顺序执行。

查看贷款经纪人配置XML文件，并了解您如何设计应用程序，您期望处理流程如下：

* 贷款经纪同步流程完成大部分工作。它通过入站端点HttpUrlCustomerRequests从浏览器接收客户贷款利率请求。

接下来，它使用脚本转换器和HttRequestToMap处理器将请求映射到Java对象，检查请求格式中的任何错误。
* 如果请求未正确格式化，则流将引发异常，并使用异常转换器将对象转换为字符串，以便输出可读。

否则，使用组件绑定，将请求传递给CreditAgency服务以验证客户的信用评级。

* 在CreditAgency服务批准后，贷款经纪同步流程使用DefaultLender服务来确定银行服务将请求传递给报价。

* 贷款经纪同步流程接下来使用收件人列表路由器向所选银行发送报价请求并汇总银行的报价响应。

* 最后，使用LowestQuoteProcessor，贷款经纪同步从列表中选择最低的报价并返回银行并引用到浏览器。

为确保应用程序正确处理错误，我们输入不正确的贷款金额并检查结果。我们输入一个数字，例如"2,760.00"，知道应用程序不会执行字符串到数字的转换。正如所料，浏览器显示错误：

[source, code, linenums]
----
java.lang.NumberFormatException: For input string: "2,760.00" (javax.script.ScriptException)
----

接下来，我们使用流量分析器确保发生的事情符合我们的预期。跟踪贷款经纪人应用程序的参数已经设置完毕，我们确信只有贷款经纪人同步流程已经执行。我们单击流程，并在Message Flow窗格中列出被调用的消息处理器。

image:loan-broker-error.png[贷款经纪人错误]

然后，我们检查每个消息处理器的前后消息负载，以确保处理器正确执行其预期的任务。如上图所示，单击一个消息处理器（如HttpRequestToMap），您可以在处理消息有效内容和处理完成后看到它的有效内容。在本例中，我们看到的结果与预期完全相同：流接收到一个作为浏览器参数`/?amount=2,760.00`传递的请求，该参数映射到对象`amount=2,760.00`。进一步检查，我们可以看到ScriptTransformer处理器在指定数字时发现错误，ExceptionTransformer和ObjectToString处理器处理准备返回给浏览器的错误消息。

接下来，我们验证应用程序可以正确处理格式化的费率请求，并通过浏览器为1000美元的贷款提交费率请求。应用程序响应速度最快。 +

image:loan-request.png[贷款请求]

为了更容易地遵循应用程序流程，我们单击清除按钮（在下面圈出）清除先前收集的数据，然后提交我们的请求。流量分析器显示处理此单个请求时发生的所有流量：

image:loan-broker-request.png[贷款经纪人请求]

== 验证消息处理器和有效负载

现在，您可以逐步浏览消息列表中的每个流程，并检查每个处理步骤的消息流和消息负载。单击“消息列表”表中的消息ID行，并在“消息详细信息”部分中显示该流的详细信息。例如，下图显示了贷款代理同步流程首次由应用程序调用时的消息处理细节。

image:loan-request-1.png[贷款请求-1]

要处理传入请求，流程依赖于消息流窗格中消息处理器部分列出的八个消息处理器。单击流中的每个消息处理器以查看其消息前后的有效负载及其入站，调用和出站元数据属性。在上图中，我们单击了处理入站端点的第一个消息处理器，并查看其有效负载是请求中的贷款金额参数。

我们检查后续的消息处理器是否正常工作。例如，我们单击HttpRequestToMap并查看它映射的金额参数。

image:loan-request-2.png[贷款请求-2]

同样，ScriptTransformer进行转换工作并添加默认贷款持续时间（未显示）。接下来，我们看到组件处理器接受转换后的贷款请求，执行所需的组件绑定以准备好报价请求。

image:loan-request-3.png[贷款请求-3] +

我们继续检查每个消息处理器和这个流的有效载荷。一旦我们确定处理过程如预期的那样，我们就会看到消息列表中下一个流程的细节。或者，我们跳到我们认为可能存在问题的流程。在下图中，我们看到银行5收到了汇率请求，并返回了似乎是最低的汇率。

image:loan-request-4.png[贷款请求-4]

我们检查贷款经纪人同步流的最后一次调用，并查看它使用四个消息处理器，最后一个将rate对象转换为字符串，以便它可以在浏览器中显示。

image:loan-request-5.png[贷款请求-5]
