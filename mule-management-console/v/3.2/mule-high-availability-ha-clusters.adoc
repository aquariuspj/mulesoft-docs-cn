=  Mule高可用性（HA）群集概述

一个簇是一组作为单元的Mule实例。换句话说，群集是由多个节点组成的虚拟服务器。集群中的服务器通过分布式共享内存网格进行通信和共享信息。这意味着数据在不同物理机器的内存中复制。

image:cluster.png[簇]

== 集群的好处

将Mule ESB服务器集中在一起可确保高系统可用性。如果节点因故障或计划停机而变得不可用，则群集中的另一个节点可承担工作负载并继续处理现有事件和消息。下图说明了由两个节点集群处理传入消息的情况。注意处理负载在节点间平衡 - 节点1处理消息1，而节点2同时处理消息2。

image:FailoverNoFail.png[FailoverNoFail]

如果一个节点发生故障，其他可用节点将接管故障节点的工作。如下图所示，如果节点2发生故障，则节点1同时处理消息1和消息2。

image:FailoverNode2Fail.png[FailoverNode2Fail]

因为集群中的所有节点都同时处理消息，所以集群还可以提高性能和可伸缩性。与单个节点实例相比，群集可以通过在多个节点之间共享工作负载或向群集添加节点来支持更多用户或提高应用程序性能。

下图更详细地说明了工作负载共享。两个节点处理与订单履行相关的消息。但是，当一个节点负载过重时，它可以将处理过程中的一个或多个步骤移动到另一个节点。这里，流程订单折扣步骤的处理将移动到节点1，并且处理完成订单步骤将移动到节点2。

image:cluster-diagram.png[群集图]

除了自动故障转移带来的高可用性，改进的性能以及增强的可扩展性之外，群集Mule实例还具有以下优点：

* 自动协调对资源（如文件，数据库和FTP源）的访问。 Mule自动管理哪个节点处理来自数据源的通信。
* 群集中处理的自动负载平衡。如果您将流分成一系列步骤，并将这些步骤与VM等传输方式相连，则每个步骤都放入一个队列中，从而启用群集。然后Mule可以处理任何节点中的每个步骤，从而更好地平衡节点间的负载。
* 集群生命周期管理和控制。请参阅 link:/mule-management-console/v/3.2/managing-mule-high-availability-ha-clusters[管理Mule高可用性（HA）群集]。
* 群集和节点性能监视。请参阅 link:/mule-management-console/v/3.2/monitoring-a-cluster[监视群集]。
* 引发警报。您可以设置一个警报，以便在节点停止运行时以及节点恢复运行时显示。请参阅 link:/mule-management-console/v/3.2/working-with-alerts[与警报一起使用]。

[NOTE]
集群中的所有Mule实例都会主动处理消息。请注意，Mule是内部可扩展的 - 通过利用多个内核，单个Mule实例可以轻松扩展。即使Mule实例利用多个核心，它仍然作为群集中的单个服务器或节点运行。

支持传输的== 群集

群集内支持所有Mule传输。由于不同传输访问入站流量的方式不同，这种支持的细节非常多。通常，出站流量在集群内部和外部的行为方式相同 - 下面突出显示差异。

Mule支持三种基本类型的传输：

* 基于套接字的传输读取发送到Mule拥有的网络套接字的输入。例子包括TCP，UDP和HTTP [mmc：S]。
基于监听器的* 传输使用完全支持并发多个访问器的协议来读取数据。示例包括JMS和VM。
基于资源的传输从允许多个并发访问者的资源中读取数据，但不会本地协调其对资源的使用。例如，假设多个程序正在通过读取，处理和删除文件来处理同一个共享目录中的文件。这些程序必须使用明确的应用程序级锁定策略来防止同一个文件被多次处理。基于资源的传输的例子包括文件，FTP，SFTP，电子邮件和JDBC。

如下所述，所有三种基本类型的传输都以不同方式在群集中得到支持。

* 插座基
** 由于每个群集Mule实例运行在不同的网络节点上，因此每个实例只接收发送到其节点的基于套接字的流量。传入的基于套接字的流量应该是mmc：负载平衡以在集群实例之间分配。
** 输出到基于套接字的传输被写入特定的主机/端口组合。如果主机/端口组合是外部主机，则不需要特别考虑。如果它是本地主机上的端口，请考虑在负载平衡器上使用该端口，以便更好地在集群间分配流量。
* 为基础的监听
** 基于监听器的传输完全支持多位读者和作者。没有特别的考虑因素适用于输入或输出。
** 请注意，在群集中，VM传输队列是共享的群集范围资源。群集将自动同步对VM传输队列的访问。因此，写入VM队列的消息可以由任何群集节点处理。这使VM成为群集节点间共享工作的理想选择。
* 资源为基础的
**  Mule HA Clustering自动协调对每个资源的访问，确保一次只有一个群集实例访问每个资源。因此，立即将从基于资源的传输中读取的消息写入VM队列通常是一个好主意。这允许其他群集节点参与处理消息。
** 写入基于资源的集群传输时没有特别考虑因素：
*** 当写入基于文件的传输（文件，FTP，SFTP）时，Mule将生成唯一的文件名。
*** 写入JDBC时，Mule可以生成唯一的密钥。
*** 撰写电子邮件实际上是基于侦听器而非基于资源的。

== 集群和可靠的应用程序

高可靠性应用（对消息丢失容忍度不高的应用）不仅要求底层ESB可靠，而且需要将可靠性扩展到单个连接。 link:/mule-user-guide/v/3.2/reliability-patterns[可靠性模式]为您提供了在群集中构建完全可靠应用程序的工具。

Mule 3.2文档提供了 link:/mule-user-guide/v/3.2/reliability-patterns[代码示例]，显示了如何为许多不同的非事务性传输（包括HTTP，FTP，File和IMAP）实现可靠性模式。如果您的应用程序使用非事务性传输，请遵循可靠性模式。这些模式确保消息被接受并成功处理，或者生成允许客户端重试的"unsuccessful"响应。

如果您的应用程序使用事务传输（例如JMS，VM和JDBC），请使用事务。 Mule对事务传输的内置支持为使用这些传输的应用程序提供可靠的消息传递。

这些操作也可以应用于非群集应用程序。

== 群集和负载平衡

当Mule群集用于提供TCP请求（其中TCP包括SSL / TLS，UDP，多播，HTTP和HTTPS）时，需要进行某些负载平衡以在群集实例之间分配请求。有各种软件负载均衡器可用，其中两个是：

*  Nginx，一款开源的HTTP服务器和反向代理。您可以使用nginx的 http://wiki.nginx.org/HttpUpstreamModule[HttpUpstreamModule]进行HTTP（S）负载平衡。您可以在Linode库条目 http://library.linode.com/web-servers/nginx/configuration/front-end-proxy-and-software-load-balancing[使用Nginx进行代理服务和软件负载平衡]中找到更多信息。
*  Apache Web服务器，也可以用作HTTP（S）负载平衡器。

还有很多硬件负载均衡器可以路由TCP和HTTP（S）流量。

== 示例应用程序

Mule Enterprise提供了一个简单的示例应用程序 link:/mule-user-guide/v/3.2/widget-example[Widget工厂]，以说明使用群集实现高可用性。此示例位于Mule主目录下的`examples/widget`目录中。请参阅该目录中的`README.txt`文件以获取有关运行该示例的信息。

== 最佳实践

有许多与群集相关的推荐做法。这些包括：

* 尽可能将应用程序组织为一系列步骤，每个步骤将消息从一个事务性商店移动到另一个事务性商店。
* 如果您的应用程序处理来自非事务性传输的消息，请使用 link:/mule-user-guide/v/3.2/reliability-patterns[可靠性模式]将它们移动到事务性商店，如VM或JMS商店。
* 使用事务处理来自事务传输的消息。这确保了如果遇到错误，消息将被重新处理。
* 使用分布式存储（如与VM或JMS传输一起使用的分布式存储） - 这些存储可用于整个群集。这比用于诸如File，FTP和JDBC之类的传输的非分布式存储更为可取 - 这些存储一次只能由单个节点读取。
* 使用VM传输来获得最佳性能。将JMS传输用于整个群集退出后需要保存数据的应用程序。
* 在集群内创建最能满足您需求的节点数量。
* 实施 link:/mule-user-guide/v/3.2/reliability-patterns[可靠性模式]以创建高可靠性应用程序。

== 先决条件和限制

* 目前，您可以创建一个由至少两台服务器和最多四台服务器组成的群集。但是，每台服务器都必须运行在不同的物理（或虚拟）机器上。
* 为了提供TCP请求，需要跨越Mule群集进行一些负载均衡。有关可以使用的第三方负载均衡器的更多信息，请参阅<<Clustering and Load Balancing>>。您还可以通过将流程分成一系列步骤并将每个步骤与诸如VM之类的传输进行连接来对集群中的处理进行负载平衡。该集群启用每一步，允许Mule更好地平衡节点间的负载。
* 必须为群集中的每个服务器启用多播。这使实例能够找到彼此。

== 集群许可

您用于群集的每个Mule服务器都必须包含启用群集的许可证。如果未安装启用集群的许可证，则将禁用该服务器的集群。您可以获得MuleSoft销售代表的集群许可证。

有关安装许可证的信息，请参阅＃[mmc：安装商业许可证]＃。
