= 使用管理控制台进行性能调整

*  <<Use Case Background>>
*  <<Detailed Performance Tuning Scenario>>
*  <<Debugging Process Details>>
*  <<Lessons Learned>>

任何特定流程都可能出现性能问题。开发人员既需要找到性能瓶颈的原因，又要制定出令人满意的解决方案。这个用例场景展示了如何使用Mule管理控制台来检测流量瓶颈并调整正在运行的Mule实例的性能。

如果您注意到流程中的性能下降，则可以使用控制台来检测并找出瓶颈。例如，您的应用程序可能会开始快速运行，但随着时间的推移，特别是随着其负载的增加，应用程序吞吐量会降低。您可以使用控制台工具查明瓶颈原因并更改流量配置以提高性能。

通常，多种因素导致性能瓶颈。您可以使用控制台以迭代方式处理所有可能性。使用控制台功能，您可以在运行时更改资源分配，查看它们如何影响流程性能，并且在不停止并重新启动Mule ESB实例的情况下执行此操作。

管理控制台允许开发人员实时监控资源利用率，并对运行中的Mule ESB实例的运行时参数（资源分配配置文件）进行更改。您可以从同一个Web控制台执行所有操作，而无需重新启动Mule ESB服务器，从而显着减少Mule实例性能调整的时间和复杂性。与过去用于监视资源使用的方法相比，这是一个重大改进，这需要使用分析器和其他外部工具。当使用外部工具时，必须停止Mule ESB实例，手动更改配置XML文件，然后Mule必须重新启动并重复测试循环。

在运行流程时，可以使用控制台窗格（如池和内存）及其各自的图表和表格来查看资源的分配和使用情况，使您能够快速确定瓶颈。当您发现问题时，您可以使用控制台更改流的资源分配，例如池的大小。流程不必停止并重新启动，控制台运行时数据可让您立即看到更改的效果。您可以根据需要进行多次传递并调整不同的资源分配参数，直到最终消除瓶颈并达到所需的性能级别。

== 使用案例背景

在这种情况下，性能问题会在部署和运行流程中发展。使用控制台，开发人员可以找出性能瓶颈的原因。在确定可能的原因后，开发人员在运行时动态更改资源分配配置，以提高流的性能。

我们的开发人员Dan致力于使用Mule ESB服务器的消息丰富化和文档聚合应用程序。该应用程序处理与医疗保健相关的患者信息。

Dan已经成功地为使用Mule IDE处理这个用例的应用程序创建了一个Mule配置。他已将应用程序部署到服务器，并且正在测试流程。在最初的测试中，Dan意识到流程中存在一些性能问题。他知道他需要调整Mule配置文件来达到所需的性能水平。

简而言之，Dan遵循以下步骤来解决问题：

* 他登录到Mule管理控制台。
* 他单击运行应用程序的服务器的“池”选项卡，然后扫描池使用情况以确定瓶颈。
* 他可以看到池大小需要更改，并且他在控制台内进行了这些更改。
* 他再次检查池利用率，然后监视其他度量标准（如内存和CPU使用率），以确保一切都正确配置。
* 他重复前三个步骤，直到达到所需的性能水平。

== 详细的性能调整方案

[WARNING]
====
下面显示的数字不一定反映调试过程的实际数据。它们只是为了说明控制台的功能。
====

当丹开始测试流量时，他立即发现一些性能问题。尽管第一次启动时应用程序性能良好，但随着应用程序负载的增加，处理吞吐量速率显着下降。

对于这个流程，客户端输入的数量为数千条消息，甚至达到100,000的数量级。消息队列的初始响应时间为每秒600条消息，提供了良好的性能。但是，随着时间的推移，消息队列将处理消息负载。结果，响应时间急剧下降，最终达到每秒一到两条消息的低点。

丹需要验证发生了什么，然后解决问题。为此，他登录到管理控制台。服务器已经注册并且流程正在运行。 Dan快速浏览仪表板，然后单击指向运行其应用程序的服务器的链接。他通过单击仪表板上的服务器运行状况portlet中的服务器名称（如下所示）来执行此操作。

image:server-info1.png[服务器INFO1]

单击服务器名称将打开显示服务器详细信息摘要的特定于服务器的仪表板窗格。在此仪表板中，Dan可以查看有关服务器的概述数据，并且有一组选项卡可以访问有关不同功能的更多详细信息。见下图。 Dan主要使用三个选项卡（内存，线程和池）来显示不同的信息并执行大部分调试工作。

image:server-info3.png[服务器INFO3]

== 调试过程详细信息

以下是Dan的调试过程可能如何进行。

* 第一步：消除明显的问题。

Dan首先消除了明显的性能瓶颈，例如内存泄漏。他从检查内存使用情况开始。服务器仪表板窗格显示服务器指标的摘要，包括内存使用情况。他扫描内存图以发现趋势：显示持续增长的内存图可能表示可能的内存泄漏。相反，他认为有一个增长的高峰期，但记忆堆在一段时间内保持不变。基于此，Dan并不担心内存泄漏。

image:server-metrics.png[服务器指标]

他单击OS资源选项卡以获取有关内存使用情况的更多信息。扫描页面及其图表，他会检查堆内存使用是否在上限，这将很好地表明性能失败的原因。

image:os-resources.png[OS-资源]

当堆用量最大时，JVM启动一个垃圾回收（GC）进程，该进程占用大部分资源并导致其他线程冻结。当他看到堆上限时，他并不感到惊讶，反应时间太糟糕了。

* 接下来，找到堆使用的根本原因。

丹想看看服务器如何处理所有正在运行的应用程序。他单击Flows选项卡，控制台显示Mule ESB实例上的所有流和流。他按状态过滤显示，以便只显示当前正在运行的流程。

image:flows.png[流动]

检查窗格时，他注意到处理与接收事件的比率表明多个流的排队事件数量很高。事实上，他推断出这些流量的70％的消息正在排队;即等待处理。开发人员知道排队时，消息在JVM上占用内存。因此，排队消息的数量可能是高内存使用率的原因，并解释了堆使用率如此之高的原因。

* 找出为什么这么多邮件排队等候。

丹现在想确定为什么这么多消息在队列中。 “池”窗格可能有答案，因此他单击控制台“服务器”选项卡，然后单击“池”选项卡。

image:pools.png[池]

在这里，他使用过滤器来搜索Dispatcher线程的线程列表，特别是负责分派消息的Dispatcher线程。他想知道该线程的活动任务数量与活动任务的最大数量的比较情况。为了更容易地使用大多数线程标识池，他单击“活动任务”列标题，以便显示按此列中的值排序。

他注意到内部VM传输的池正在使用16个Max Active线程中的16个活动线程，表明线程已耗尽。显然，这是瓶颈。与此同时，Dan注意到其他类型的线程（包括流处理用例的池）没有很多工作活动线程。鉴于这些信息，他怀疑整个过程是同步的。他需要测试JMS端点，文件端点和VM端点以查看是否属于这种情况。

* 检查应用程序配置文件以查看端点是如何设置的。

在Mule ESB服务器上启动应用程序的应用程序配置文件定义了端点的参数。一个这样的参数指示端点是设置为同步还是异步（异步是默认设置）。

Dan单击文件选项卡，然后导航到/ apps目录中的用例应用程序文件夹，然后单击应用程序配置文件将其打开。检查文件，他发现端点设置为同步。他单击编辑按钮（如下图所示）将端点配置更改为异步。

image:edit-config.png[编辑配置]

他保存配置文件并重新运行应用程序，立即看到性能大幅提升。但是，性能仍然可以更好。

* 使用管理控制台窗格继续迭代搜索瓶颈的根本原因。

Dan打开控制台Flows窗格，并再次看到消息排队。虽然数字更好，但它们仍然不是最佳的。他再次点击Pools选项卡，发现可疑的Dispatcher线程再次耗尽，还有其他几个流程。

* 增加调度程序线程的最大活动线程数。

Dan直接通过控制台工作，将调度程序线程的Max Active线程数量增加到50。他单击调度程序线程的当前最大活动值。控制台以可编辑模式重新显示所选线程，Dan将16改为50.他点击保存以确保存储新值。

image:max-threads.png[最大线程]

* 平衡所有流上的事件处理负载。

为了获得更好的性能，Dan希望平衡整个服务器上的事件处理负载。他单击“流”选项卡检查事件处理编号。通过Flows选项卡，他可以查看流程的流程事件，总收到的事件以及平均和总事件处理时间。

image:events-proc.png[事件进程内]

根据他所看到的情况，他可能希望为处理较少事件的流增加最大活动线程数，因为它们可能在其各自的队列中等待更多的消息，并且可能会降低处理大量事件的流的最大活动值。他还单击线程选项卡并查看WC（等待计数）和BC（阻止计数）值以估计事件处理的速率。

经过一些额外的数据分析后，他再次检查OS资源选项卡，并注意到CPU被高度利用（在95％和100％之间），无论流量性能如何。他得出结论，由于大多数内部VM传输线程在执行上下文切换时正在等待CPU时间，因此传输没有完成其工作。为了缓解这个问题，Dan减少了VM池大小（VM传输的最大活动线程数），并立即注意到池活动任务的增加以及应用程序性能的提高。通过一些试验和错误，Dan为运行Mule服务器的特定硬件的池配置找到正确的值和负载平衡。

* 再次检查内存使用情况。

丹返回到内存窗格，并看到堆内存再次用完。他知道他必须更改一些额外的特定于内存的配置值。 Dan单击文件选项卡，导航到/ conf目录，并打开wrapper.conf文件。

image:wrapper.png[包装纸]

他检查文件中设置的初始和最大堆值，并看到初始堆大小设置为三兆字节，最大堆大小设置为512兆字节。他单击编辑按钮，将初始最大堆大小增加到1千兆字节，然后保存wrapper.config文件。

image:wrapper-edit.png[包装编辑]

* 再次运行负载测试。

丹再次运行测试。他不仅在开始时看到了良好的表现，而且性能保持在每秒600条消息。 Dan使用管理控制台查看影响性能的系统方面，并更改了这些值以实现最佳性能吞吐量。

== 经验教训

Mule管理控制台让Dan能够实时工作：他能够监控资源利用率并动态地改变正在运行的Mule实例的参数。他可以从同一个Web控制台执行所有操作，而无需重新启动Mule服务器。结果，调整Mule实例性能的时间和复杂度显着降低。

如果Dan没有可用的控制台功能，则性能调整将耗费更多时间和难度。对Mule实例参数的更改需要多次停止服务器，手动对配置文件进行更改，然后重新启动服务器。

另外，Dan需要使用Java Profiler这个复杂工具的经验，并且必须以调试模式运行Mule服务器。即便如此，这可能没有帮助，因为分析器只显示有关Java对象，线程利用率和性能的低级数据。为了利用这些低级数据，Data需要内部Mule体系结构的知识。

Dan发现使用管理控制台不仅降低了复杂性，而且还缩短了解决方案的时间。调试过程更快，因为他不必停止并重新启动Mule实例。他可以直接从控制台进行所有必要的更改，无论是参数还是配置文件。

Dan能够处理特定于Mule ESB服务器的高级数据和指标。他只需要关于流程结构的知识，而不需要关于Mule架构的细节和分析器的专业知识。
